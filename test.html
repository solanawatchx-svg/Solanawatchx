
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bug Fix Verification Test</title>
</head>
<body>
    <h1>Bug Fix Verification</h1>
    <p>This page tests the fix for the token feed flickering issue.</p>
    <div id="status"></div>
    <div id="token-feed"></div>
    <div id="test-results"></div>

    <script>
        // Mock the fetch function to return controlled data
        let fetchCallCount = 0;
        const mockTokensBatch1 = Array.from({ length: 5 }, (_, i) => ({
            coinMint: `mint${i}`, name: `Token ${i}`, ticker: `TKN${i}`, creationTime: Date.now() - i * 10000
        }));
        const mockTokensBatch2 = [
            { coinMint: 'mint_new', name: 'New Token', ticker: 'NEW', creationTime: Date.now() + 10000 },
            ...mockTokensBatch1.slice(0, 4)
        ];

        // Override fetch
        const originalFetch = window.fetch;
        window.fetch = async (url) => {
            if (url.includes('live-tokens')) {
                fetchCallCount++;
                if (fetchCallCount === 1) {
                    return new Response(JSON.stringify({ tokens: mockTokensBatch1 }), { status: 200 });
                }
                if (fetchCallCount > 1) {
                    // This is where the test happens
                    const feed = document.getElementById('token-feed');
                    // Add a marker to an existing element
                    if (feed.children.length > 0) {
                        feed.children[0].setAttribute('data-test-marker', 'should-persist');
                    }
                    return new Response(JSON.stringify({ tokens: mockTokensBatch2 }), { status: 200 });
                }
            }
            return new Response(JSON.stringify({}), { status: 404 });
        };
    </script>

    <!-- Load the script to be tested -->
    <script src="script.js"></script>

    <script>
        // --- Test Verification ---
        const POLLING_INTERVAL_MS = 4000; // from script.js
        setTimeout(() => {
            const resultsContainer = document.getElementById('test-results');
            const feed = document.getElementById('token-feed');
            const markedElement = feed.querySelector('[data-test-marker="should-persist"]');

            // With the old buggy code, the entire innerHTML is wiped, so the marker would be gone.
            // With the fix, the old elements are preserved, and new ones are prepended.
            let success = true;
            let message = '';

            if (feed.children.length !== 6) {
                success = false;
                message = `FAIL: Expected 6 tokens in the feed, but found ${feed.children.length}.`;
            } else if (feed.children[0].dataset.mint !== 'mint_new') {
                success = false;
                message = 'FAIL: The new token was not prepended to the top of the feed.';
            } else if (!markedElement) {
                // This is the key check for the "flicker" (re-render) bug.
                success = false;
                message = 'FAIL: The feed was completely re-rendered (flickering). The test marker was lost.';
            } else {
                message = 'PASS: The new token was prepended correctly without re-rendering the entire feed.';
            }

            resultsContainer.innerHTML = `<h2 style="color: ${success ? 'green' : 'red'}">${message}</h2>`;

            // Restore fetch
            window.fetch = originalFetch;

        }, POLLING_INTERVAL_MS + 1000); // Wait for the second fetch to complete
    </script>
</body>
</html>
